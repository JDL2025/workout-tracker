<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Workout Tracker">
    <link rel="manifest" href="manifest.json">
    <title>üèãÔ∏è Workout Tracker</title>
    <style>
        :root {
            /* Light Mode Colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #999999;
            --border-color: #e0e0e0;
            --border-light: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-primary: #667eea;
            --button-hover: #5568d3;
            --button-active: #4a5abf;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --highlight-bg: #c8e6c9;
            --highlight-border: #4caf50;
            --info-bg: #e3f2fd;
            --info-text: #1976d2;
        }

        [data-theme="dark"] {
            /* Dark Mode Colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --bg-card: #2a2a3e;
            --bg-input: #1f1f2e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-light: #808080;
            --border-color: #404050;
            --border-light: #505060;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --button-primary: #7b8fd4;
            --button-hover: #8a9ee0;
            --button-active: #6a7fc0;
            --success-bg: #1e4620;
            --success-text: #90ee90;
            --error-bg: #4a1f1f;
            --error-text: #ff6b6b;
            --highlight-bg: #2d4a2f;
            --highlight-border: #66bb6a;
            --info-bg: #1e3a5f;
            --info-text: #64b5f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 200px; /* Extra space for footer on mobile */
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: var(--button-primary);
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .date-display {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .date-display button {
            background: none;
            border: none;
            color: var(--button-primary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            padding: 5px;
        }
        
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-btn {
            padding: 15px 10px;
            border: 2px solid var(--button-primary);
            background: var(--bg-card);
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--button-primary);
            touch-action: manipulation;
        }
        
        .category-btn:active, .category-btn.active {
            background: var(--button-primary);
            color: white;
            transform: scale(0.95);
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .exercise-btn {
            padding: 12px;
            border: 2px solid var(--border-light);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            touch-action: manipulation;
        }
        
        .exercise-btn:active {
            background: var(--border-color);
            transform: scale(0.98);
        }

        .exercise-btn.selected {
            background: var(--highlight-bg);
            border-color: var(--highlight-border);
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .previous-data {
            background: var(--info-bg);
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .previous-data strong {
            color: var(--info-text);
        }

        .workout-history-item {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #1976d2;
        }

        .workout-history-item .date {
            font-weight: bold;
            color: var(--info-text);
            margin-bottom: 3px;
        }

        .workout-history-item .sets {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .show-more-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-card);
            color: var(--info-text);
            border: 2px solid #1976d2;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: bold;
        }

        .show-more-btn:active {
            background: var(--info-bg);
        }

        .cardio-form {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .cardio-field {
            margin-bottom: 12px;
        }

        .cardio-field label {
            display: block;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cardio-field input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .cardio-field input[type="text"]:focus {
            outline: none;
            border-color: var(--button-primary);
        }

        .cardio-checkbox {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: var(--border-color);
            border-radius: 8px;
        }

        .cardio-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .cardio-checkbox label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            cursor: pointer;
        }

        .norwegian-rounds {
            margin-left: 30px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .norwegian-rounds input {
            width: 50px;
            padding: 8px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .norwegian-rounds input:focus {
            outline: none;
            border-color: var(--button-primary);
        }

        .norwegian-rounds span {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .hidden {
            display: none;
        }
        
        .input-section {
            background: var(--info-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--info-text);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .input-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .quick-entry {
            margin-bottom: 15px;
        }
        
        .quick-entry input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .quick-entry input:focus {
            outline: none;
            border-color: var(--button-primary);
        }
        
        .quick-entry-hint {
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .set-inputs {
            display: grid;
            gap: 10px;
        }
        
        .set-row {
            display: grid;
            grid-template-columns: 80px 1fr 60px;
            gap: 10px;
            align-items: center;
        }
        
        .set-row span {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .set-row input {
            padding: 10px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .set-row input:focus {
            outline: none;
            border-color: var(--button-primary);
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            touch-action: manipulation;
        }
        
        .submit-btn:active {
            background: #45a049;
            transform: scale(0.98);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .todays-workout {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 3px solid #eee;
        }
        
        .todays-workout h3 {
            color: var(--button-primary);
            margin-bottom: 15px;
        }
        
        .workout-item {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid var(--border-color);
            border-left: 4px solid #4caf50;
        }
        
        .workout-item strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 5px;
        }
        
        .workout-item span {
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--button-primary);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .btn-secondary {
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .btn-secondary:active {
            transform: scale(0.95);
        }

        /* Delete Button Styles */
        .delete-btn {
            background: transparent;
            color: #ff5252;
            border: 2px solid #ff5252;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 40px;
        }

        .delete-btn:hover {
            background: #ff5252;
            color: white;
            transform: scale(1.05);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }


        /* Add button to add more sets */
        .add-set-btn {
            width: 100%;
            padding: 10px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .clear-sets-btn {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            color: #dc3545;
            border: 2px solid #dc3545;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .clear-sets-btn:active {
            background: #dc3545;
            color: white;
        }

        .end-workout-btn {
            width: 100%;
            padding: 15px;
            background: var(--bg-card);
            color: #dc3545;
            border: 2px solid #dc3545;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            touch-action: manipulation;
        }

        .end-workout-btn:active {
            background: #dc3545;
            color: white;
        }

        .timer-display {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            font-size: 18px;
            color: var(--button-primary);
            font-weight: bold;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:active {
            transform: scale(0.98);
        }

        .tab-btn.active {
            background: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
        }

        /* Tab Content Containers */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Container Styling */
        .stats-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .stats-period-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn:active {
            transform: scale(0.98);
        }

        .period-btn.active {
            background: var(--info-bg);
            border-color: var(--info-text);
            color: var(--info-text);
        }

        .stats-display {
            background: var(--info-bg);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--info-text);
        }

        .stats-display h3 {
            color: var(--info-text);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-size: 16px;
        }

        /* App Footer */
        .app-footer {
            margin-top: 60px;
            margin-bottom: 20px;
            padding: 24px 20px;
            background: var(--bg-card);
            border-top: 2px solid var(--border-color);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Connection Status Badge */
        .connection-status {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* View Spreadsheet Button */
        .view-sheet-btn {
            background: #0f9d58;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
        
        .view-sheet-btn:hover {
            background: #0d8b4d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 157, 88, 0.3);
        }
        
        .view-sheet-btn:active {
            transform: translateY(0);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #4caf50;
        }

        .status-local {
            background: #ff9800;
        }

        .status-error {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Error Banner */
        .error-banner {
            background: #ff5252;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            display: none;
            position: relative;
        }

        .error-banner.show {
            display: block;
        }

        .warning-banner {
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            display: none;
            position: relative;
        }

        .warning-banner.show {
            display: block;
        }

        .banner-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .banner-button:active {
            background: rgba(255,255,255,0.3);
        }

        /* Pending Uploads Indicator */
        .pending-uploads {
            background: var(--info-bg);
            border: 2px solid var(--info-text);
            border-radius: 10px;
            padding: 12px;
            margin: 15px 0;
            display: none;
        }

        .pending-uploads.show {
            display: block;
        }

        .pending-uploads h4 {
            color: var(--info-text);
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .pending-item {
            background: var(--bg-card);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-primary);
        }

        /* Mobile-specific adjustments for iPhone and small screens */
        @media (max-width: 600px) {
            /* Fix set-row layout to keep √ó buttons inside frame */
            .set-row {
                grid-template-columns: 50px 140px 50px;
                gap: 8px;
            }
            
            /* Ensure buttons don't overflow */
            .btn-secondary {
                min-width: 45px;
                width: 45px;
                padding: 8px 10px;
            }
            
            /* Adjust input padding for better mobile fit */
            .set-row input {
                padding: 10px 8px;
                font-size: 16px;
                width: 100%;
                max-width: 140px;
            }
            
            /* Keep everything contained within input-section */
            .input-section {
                padding: 12px;
                overflow: hidden;
            }
            
            /* Ensure set labels are readable but compact */
            .set-row span {
                font-size: 14px;
            }
        }
        /* ============================================================================
           WORKOUT FLASHBACK STYLES
           ============================================================================ */
        
        .workout-flashback {
            margin: 30px 0 40px 0;
            padding: 0 10px;
        }
        
        .workout-flashback h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .flashback-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .flashback-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s ease;
        }
        
        .flashback-header:hover {
            background: var(--hover-bg);
        }
        
        .flashback-header-info {
            flex: 1;
        }
        
        .flashback-date {
            font-weight: bold;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .flashback-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .flashback-expand-icon {
            font-size: 20px;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }
        
        .flashback-card.expanded .flashback-expand-icon {
            transform: rotate(180deg);
        }
        
        .flashback-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--border-color);
        }
        
        .flashback-card.expanded .flashback-content {
            max-height: 2000px;
        }
        
        .flashback-exercises {
            padding: 15px 20px;
        }
        
        .flashback-exercise {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .flashback-exercise:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .flashback-exercise-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .flashback-exercise-data {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .flashback-show-more {
            text-align: center;
            margin-top: 15px;
        }
        
        .flashback-show-more button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .flashback-show-more button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .flashback-show-more button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner">
        <span id="errorMessage"></span>
        <button class="banner-button" onclick="retryConnection()">Retry</button>
    </div>
    
    <!-- Warning Banner -->
    <div class="warning-banner" id="warningBanner">
        <span id="warningMessage"></span>
        <button class="banner-button" onclick="viewPendingUploads()">View</button>
    </div>
    
    <div class="container">
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px; position: relative;">
            <h1 style="margin: 0; padding: 0 55px;">üèãÔ∏è Workout Tracker</h1>
            <button onclick="toggleDarkMode()" style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 50%; width: 44px; height: 44px; font-size: 20px; cursor: pointer; transition: all 0.3s ease; position: absolute; right: 0;" id="themeToggle">
                üåô
            </button>
        </div>
        <div class="date-display">
            <div id="currentDate"></div>
            <input type="date" id="datePicker" style="position: absolute; opacity: 0; pointer-events: none;">
            <button onclick="changeDatePicker()">Change Date</button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('today')" id="todayTab">
                üìù Today
            </button>
            <button class="tab-btn" onclick="switchTab('stats')" id="statsTab">
                üìä Stats
            </button>
        </div>

        <div id="message" class="hidden"></div>

        <!-- OAuth2 Sign-In Overlay -->
        <div id="authOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: var(--bg-primary); padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; border: 2px solid var(--info-text);">
                <h2 style="color: var(--text-primary); margin-bottom: 15px;">üîê Sign In Required</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">
                    To save workouts to your Google Sheet, please sign in with your Google account.
                </p>
                <button onclick="signInWithGoogle()" style="background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                <p style="color: var(--text-light); font-size: 12px; margin-top: 15px;">
                    Your data stays in your Google Sheet. We never store your credentials.
                </p>
            </div>
        </div>

        <!-- TODAY TAB CONTENT -->
        <div id="todayContent" class="tab-content active">

        <!-- Search Box -->
        <input type="text" class="search-box hidden" id="searchBox" placeholder="üîç Search exercises..." onkeyup="filterExercises()">

        <!-- Category Buttons -->
        <div class="category-buttons">
            <button class="category-btn" onclick="showCategory('Chest')">üí™ Chest</button>
            <button class="category-btn" onclick="showCategory('Back')">üîô Back</button>
            <button class="category-btn" onclick="showCategory('Arms')">üí™ Arms</button>
            <button class="category-btn" onclick="showCategory('Shoulders')">‚≠ê Shoulders</button>
            <button class="category-btn" onclick="showCategory('Legs')">ü¶µ Legs</button>
            <button class="category-btn" onclick="showCategory('Core')">‚≠ê Core</button>
            <button class="category-btn" onclick="showCategory('Cardio')">üèÉ Cardio</button>
            <button class="category-btn" onclick="showCategory('Other')">üîß Other</button>
        </div>

        <!-- Exercise Grid -->
        <div class="exercise-grid hidden" id="exerciseGrid"></div>

        <!-- Previous Data Display -->
        <div class="previous-data hidden" id="previousData"></div>

        <!-- Input Section -->
        <div class="input-section hidden" id="inputSection">
            <h3 id="selectedExercise"></h3>
            
            <div id="previousData" class="previous-data hidden"></div>
            
            <!-- Weight Training Input -->
            <div id="weightInput">
                <div class="quick-entry">
                    <input type="text" id="quickEntry" placeholder="e.g., 4@50 or 4@25/30/35/40">
                    <div class="quick-entry-hint">Quick entry: [sets]@[weight] or [sets]@[w1/w2/w3...]</div>
                </div>

                <div id="setInputs" class="set-inputs"></div>
                
                <button class="add-set-btn" onclick="addEmptySet()">+ Add Another Set</button>
                <button class="clear-sets-btn" onclick="clearAllSets()">üóëÔ∏è Clear All Sets</button>
            </div>

            <!-- Cardio Input -->
            <div id="cardioInput" class="cardio-form hidden">
                <div id="norwegianRoundsField" class="hidden" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">Rounds:</label>
                    <div class="norwegian-rounds" style="margin-left: 0;">
                        <input type="text" id="norwegianSets" placeholder="4" maxlength="2">
                        <span>√ó</span>
                        <input type="text" id="norwegianMins" placeholder="4" maxlength="2">
                        <span>minutes</span>
                    </div>
                </div>

                <div class="cardio-field">
                    <label for="cardioDuration">Duration (MM:SS):</label>
                    <input type="text" id="cardioDuration" placeholder="e.g., 45:00">
                </div>

                <div class="cardio-field">
                    <label for="cardioDistance">Distance (miles):</label>
                    <input type="text" id="cardioDistance" placeholder="e.g., 5.0">
                </div>

                <div class="cardio-field">
                    <label for="cardioCalories">Calories:</label>
                    <input type="text" id="cardioCalories" placeholder="e.g., 650">
                </div>

                <div class="cardio-field">
                    <label for="cardioSpeed" id="cardioSpeedLabel">Speed:</label>
                    <input type="text" id="cardioSpeed" placeholder="e.g., 6.5">
                </div>

                <div class="cardio-checkbox">
                    <input type="checkbox" id="zone2Checkbox">
                    <label for="zone2Checkbox">Zone 2 workout</label>
                </div>

                <div class="cardio-field">
                    <label for="cardioNotes">Notes (optional):</label>
                    <input type="text" id="cardioNotes" placeholder="e.g., sprint stairs">
                </div>
            </div>

            <!-- Submit Message (appears right above button) -->
            <div id="submitMessage" class="hidden" style="margin: 10px 0;"></div>

            <button class="submit-btn" onclick="submitWorkout()">‚úì SUBMIT</button>
        </div>

        <!-- Pending Uploads Indicator -->
        <div class="pending-uploads" id="pendingUploads">
            <h4>üì§ Pending Uploads (<span id="pendingCount">0</span>)</h4>
            <div id="pendingList"></div>
            <button class="btn-secondary" onclick="retryAllUploads()" style="width: 100%; margin-top: 8px;">Retry All</button>
        </div>

        <!-- Today's Workout Summary -->
        <div class="todays-workout">
            <h3>Today's Workout</h3>
            <div id="todaysSummary">
                <div style="color: var(--text-light); text-align: center; padding: 20px;">No exercises logged yet</div>
            </div>
            <div class="timer-display" id="timerDisplay">‚è±Ô∏è Gym time: 0:00</div>
            <button class="end-workout-btn hidden" id="endWorkoutBtn" onclick="endWorkoutSession()">üèÅ End Workout Session</button>
        </div>

        <!-- WORKOUT FLASHBACK SECTION -->
        <div class="workout-flashback">
            <h3>üìÖ Workout Flashback</h3>
            <div id="flashbackContainer">
                <!-- Workout cards will be inserted here -->
            </div>
            <div class="flashback-show-more" id="flashbackShowMore" style="display: none;">
                <button onclick="showMoreFlashbacks()">Show More...</button>
            </div>
        </div>

        </div>
        <!-- END TODAY TAB CONTENT -->

        <!-- STATS TAB CONTENT -->
        <div id="statsContent" class="tab-content">
            <div class="stats-container">
                <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 20px;">üìä Workout Statistics</h2>
                
                <!-- Period Selection Buttons -->
                <div class="stats-period-buttons">
                    <button class="period-btn active" onclick="showStatsPeriod('week')" id="weekBtn">
                        üìÖ This Week
                    </button>
                    <button class="period-btn" onclick="showStatsPeriod('month')" id="monthBtn">
                        üìÜ This Month
                    </button>
                    <button class="period-btn" onclick="showStatsPeriod('year')" id="yearBtn">
                        üìà This Year
                    </button>
                    <button class="period-btn" onclick="showStatsPeriod('lifetime')" id="lifetimeBtn">
                        üèÜ Lifetime
                    </button>
                </div>
                
                <!-- Personal Records Button (Full Width) -->
                <button class="period-btn" onclick="showStatsPeriod('records')" id="recordsBtn" style="width: 100%; margin-bottom: 20px;">
                    üèÜ Personal Records
                </button>

                <!-- Stats Display Area -->
                <div class="stats-display">
                    <div id="statsDataDisplay">
                        <div class="stats-placeholder">
                            <h3>üìä This Week</h3>
                            <p style="margin-top: 20px;">Stats calculations coming soon!</p>
                            <p style="margin-top: 10px; font-size: 14px;">Your workout data will be analyzed and displayed here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END STATS TAB CONTENT -->

    </div>

    <script>
        // Configuration - Google Sheets API
        const GOOGLE_API_KEY = 'AIzaSyDD_ywq0arc6Y8BVo0ujpp9rPoAxoE_who';
        const SPREADSHEET_ID = '1RPljHN0A5gYn_Mw-2c0IJH9qEB8jvcVla0NaJ1fo5HM';
        
        // OAuth2 Configuration
        const OAUTH_CLIENT_ID = '907578491938-o6glfpeksarbe1e39pa9ubgen28njdod.apps.googleusercontent.com';
        const OAUTH_SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        
        // OAuth2 Access Token (stored in localStorage)
        let accessToken = localStorage.getItem('google_access_token');
        let tokenExpiry = localStorage.getItem('google_token_expiry');
        
        // Using default first sheet - no need to specify name
        
        // Will replace DEMO_WORKOUTS with real data from sheet
        let REAL_WORKOUTS = [];
        let dataLoaded = false;
        
        // Exercise Database
        const EXERCISES = {
            'Chest': ['Flat Chest Press Dumbbell', 'Flat Chest Press Supine Machine', 'Flat Chest Press Barbell', 'Incline Chest Press Dumbbell', 'Incline Chest Press Machine', 'Chest Butterfly Machine'],
            'Back': ['Cable Row Linked - Narrow Grip', 'Cable Row Linked - Wide Grip', 'Cable Row Linked - W-Bar', 'Cable Row Linked - Medium Wide Grip', 'Double Cable Row Independent', 'Double Cable Row Linked - Narrow Grip', 'Dumbbell Row', 'Lat Pulldown', 'Pull-Ups Assisted', 'Pull-Ups Unassisted', 'Reverse Butterfly Machine'],
            'Arms': ['Bicep Curls Dumbbell', 'Bicep Curls EZ Bar', 'Bicep Curls Flat Bar', 'Bicep Hammer Curls', 'Bicep Preacher Curl Machine', 'Tricep Rope Pull', 'Tricep Skulls', 'Tricep Cable Pull V-Bar', 'Tricep Press Machine', 'Tricep Single Arm Cable Pull', 'Dips Assisted', 'Dumbbell Forearm Curls'],
            'Shoulders': ['Military Press Dumbbell', 'Shoulder Lateral Raises Dumbbell', 'Shoulder Lateral Raises Cable', 'Shoulder Front Raises Dumbbell', 'High Pulls Dumbbell', 'Rear Delt Cable Face Pulls'],
            'Legs': ['Goblet Squat Dumbbell', 'Hack Squat Machine', 'Leg Press Machine', 'Reverse Lunges Dumbbell', 'Bulgarian Split Squats Dumbbell'],
            'Core': ['Abs Leg Raises', 'Abs Crunches'],
            'Cardio': ['Treadmill', 'Outdoor Run', 'Stair Machine', 'Norwegian Intervals', 'Rowing Erg', 'Outdoor Hike'],
            'Other': ['Farmer\'s Carry with Shrugs', 'Suitcase Carry with Shrugs', 'Shrugs', 'Push-Ups', 'Dead-Hangs', 'Tricep Dips', 'Physical Therapy Workout', 'Cable Pull-Through Hinge', 'Sauna']
        };

        // State
        let currentDate = new Date();
        let selectedExercise = null;
        let selectedCategory = null;
        let todaysWorkouts = [];
        let setCounter = 0;
        let workoutStartTime = Date.now();
        let timerInterval = null;
        let previousWorkoutsToShow = 3;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let flashbackWorkoutsShown = 2; // Start with 2 workouts visible
        let flashbackWorkouts = []; // Stores the grouped workout data

        // Initialize
        document.getElementById('currentDate').textContent = formatDate(currentDate);
        loadTodaysWorkouts();
        startTimer();
        initDarkMode();
        
        // Load workout data from Google Sheets (for stats) - wait a moment for DOM to be fully ready
        setTimeout(() => {
            loadWorkoutDataFromSheet();
        }, 100);

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const year = date.getFullYear();
            return `üìÖ ${month}/${day}/${year}`;
        }

        function formatDateForSheet(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            // Use ISO format (YYYY-MM-DD) so Google Sheets recognizes it as a date, not text
            return `${year}-${month}-${day}`;
        }

        function initDarkMode() {
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('themeToggle').textContent = 'üåô';
            }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('themeToggle').textContent = 'üåô';
            }
        }

        // Demo Workout Data for Stats (structured like CSV)
        const DEMO_WORKOUTS = [
            // Last 7 days
            { date: '12/12/2025', exercise: 'Flat Chest Press Dumbbell', category: 'Chest', sets: [50, 50, 50, 50] },
            { date: '12/12/2025', exercise: 'Cable Row Linked - Narrow Grip', category: 'Back', sets: [130, 145, 145, 130] },
            { date: '12/12/2025', exercise: 'Abs Crunches', category: 'Core', sets: ['BW', 'BW', 'BW', 'BW'] },
            { date: '12/10/2025', exercise: 'Treadmill', category: 'Cardio', distance: 5.0, duration: '45:00', calories: 650, zone2: true },
            { date: '12/9/2025', exercise: 'Military Press Dumbbell', category: 'Shoulders', sets: [30, 30, 30, 30] },
            { date: '12/9/2025', exercise: 'Bicep Curls EZ Bar', category: 'Arms', sets: [60, 60, 60, 60] },
            { date: '12/9/2025', exercise: 'Tricep Skulls', category: 'Arms', sets: [50, 50, 50, 50] },
            { date: '12/7/2025', exercise: 'Norwegian Intervals', category: 'Cardio', distance: 4.0, duration: '48:00', calories: 600, norwegian: true },
            { date: '12/6/2025', exercise: 'Lat Pulldown', category: 'Back', sets: [120, 120, 120, 120] },
            { date: '12/6/2025', exercise: 'Reverse Butterfly Machine', category: 'Back', sets: [100, 100, 100, 100] },
            
            // Last 30 days
            { date: '11/28/2025', exercise: 'Flat Chest Press Supine Machine', category: 'Chest', sets: [50, 50, 50, 50] },
            { date: '11/28/2025', exercise: 'Cable Row Linked - W-Bar', category: 'Back', sets: [100, 100, 100, 100] },
            { date: '11/25/2025', exercise: 'Norwegian Intervals', category: 'Cardio', distance: 4.05, duration: '48:00', calories: 600, norwegian: true },
            { date: '11/22/2025', exercise: 'Military Press Dumbbell', category: 'Shoulders', sets: [30, 30, 30, 30] },
            { date: '11/22/2025', exercise: 'Bicep Curls EZ Bar', category: 'Arms', sets: [60, 60, 60, 60] },
            { date: '11/15/2025', exercise: 'Hack Squat Machine', category: 'Legs', sets: [90, 90, 90, 90] },
            { date: '11/15/2025', exercise: 'Goblet Squat Dumbbell', category: 'Legs', sets: [30, 30, 30, 30] },
            
            // Last year
            { date: '6/15/2025', exercise: 'Flat Chest Press Dumbbell', category: 'Chest', sets: [65, 65, 65, 65] },
            { date: '3/20/2025', exercise: 'Outdoor Run', category: 'Cardio', distance: 5.1, duration: '39:00', calories: 700 },
            { date: '1/10/2025', exercise: 'Flat Chest Press Dumbbell', category: 'Chest', sets: [65, 65, 65, 65] }
        ];

        // Fetch and Parse Google Sheets Data
        async function loadWorkoutDataFromSheet() {
            try {
                console.log('üîÑ Fetching workout data from Google Sheets API...');
                updateConnectionStatus('loading', 'Loading...');
                
                // Build the API URL - using A:M without sheet name (uses first sheet)
                const range = 'A:M'; // All columns A through M
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${GOOGLE_API_KEY}`;
                
                console.log('üìç API URL:', url);
                
                const response = await fetch(url);
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);
                
                if (!response.ok) {
                    // Get the actual error message from Google
                    const errorData = await response.json();
                    console.error('‚ùå Google API Error:', errorData);
                    console.error('‚ùå Error details:', JSON.stringify(errorData, null, 2));
                    
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                console.log(`üìä Received ${data.values.length} rows from Google Sheets`);
                console.log(`üìä First row (header):`, data.values[0]);
                console.log(`üìä Second row (data):`, data.values[1]);
                
                // Parse the data
                REAL_WORKOUTS = parseGoogleSheetsData(data.values);
                dataLoaded = true;
                
                console.log(`‚úÖ Successfully loaded ${REAL_WORKOUTS.length} workout entries!`);
                console.log(`üìä Sample workout:`, REAL_WORKOUTS[0]);
                if (REAL_WORKOUTS.length > 5) {
                    console.log(`üìä Another sample:`, REAL_WORKOUTS[5]);
                }
                
                updateConnectionStatus('connected', 'Connected');
                hideErrorBanner();
                
                // Load workout flashback
                loadWorkoutFlashback();
                
                // Refresh stats if on stats tab
                if (currentTab === 'stats') {
                    renderStatsPeriod(currentStatsPeriod);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading sheet data:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                console.log('‚ö†Ô∏è Falling back to demo data');
                
                dataLoaded = false;
                updateConnectionStatus('error', 'Connection Error');
                showErrorBanner(`‚ö†Ô∏è Can't reach Google Sheets: ${error.message}`);
            }
        }

        function parseGoogleSheetsData(rows) {
            const workoutMap = {}; // Group by date + exercise
            let totalRowsParsed = 0;
            let skippedRows = 0;
            
            // Skip header row (index 0)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                
                if (!row || row.length < 7) {
                    skippedRows++;
                    continue; // Skip invalid rows
                }
                
                totalRowsParsed++;
                
                const date = row[0] || '';
                const exercise = row[1] || '';
                const sets = row[2] || '';
                const reps = row[3] || '';
                const weight = row[4] || '';
                const notes = row[5] || '';
                const category = row[6] || '';
                const distance = row[7] || '';
                const duration = row[8] || '';
                const calories = row[9] || '';
                const speedPace = row[10] || '';
                const zone2 = row[11] || '';
                const norwegian = row[12] || '';
                
                // Create unique key for grouping
                const key = `${date}|${exercise}`;
                
                // Build workout object
                if (category === 'Cardio') {
                    // Cardio workout - no grouping needed (already one entry per cardio session)
                    if (!workoutMap[key]) {
                        workoutMap[key] = {
                            date: date,
                            exercise: exercise,
                            category: 'Cardio',
                            cardio: true,
                            distance: distance ? parseFloat(distance) : null,
                            duration: duration || null,
                            calories: calories ? parseInt(calories) : null,
                            zone2: zone2 === 'Yes',
                            norwegian: norwegian === 'Yes',
                            displayText: buildCardioDisplayText(distance, duration, calories)
                        };
                    }
                } else {
                    // Strength workout - group sets together
                    if (!workoutMap[key]) {
                        workoutMap[key] = {
                            date: date,
                            exercise: exercise,
                            category: category,
                            sets: []
                        };
                    }
                    
                    // Add this set to the array
                    if (weight) {
                        workoutMap[key].sets.push(parseFloat(weight));
                    } else {
                        workoutMap[key].sets.push('BW');
                    }
                }
            }
            
            console.log(`üìä Parsed ${totalRowsParsed} rows, skipped ${skippedRows} rows`);
            console.log(`üìä Grouped into ${Object.keys(workoutMap).length} unique workout entries`);
            
            // Convert map to array
            return Object.values(workoutMap);
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const workoutMap = {}; // Group by date + exercise
            let totalRowsParsed = 0;
            let skippedRows = 0;
            
            // Skip header row (index 0)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    skippedRows++;
                    continue; // Skip empty lines
                }
                
                // Parse CSV line (handle commas in quoted fields)
                const columns = parseCSVLine(line);
                
                if (columns.length < 7) {
                    console.log(`‚ö†Ô∏è Skipping row ${i}: only ${columns.length} columns`);
                    skippedRows++;
                    continue; // Skip invalid rows
                }
                
                totalRowsParsed++;
                
                const date = columns[0];
                const exercise = columns[1];
                const sets = columns[2];
                const reps = columns[3];
                const weight = columns[4];
                const notes = columns[5];
                const category = columns[6];
                const distance = columns[7];
                const duration = columns[8];
                const calories = columns[9];
                const speedPace = columns[10];
                const zone2 = columns[11];
                const norwegian = columns[12];
                
                // Create unique key for grouping
                const key = `${date}|${exercise}`;
                
                // Build workout object
                if (category === 'Cardio') {
                    // Cardio workout - no grouping needed (already one entry per cardio session)
                    if (!workoutMap[key]) {
                        workoutMap[key] = {
                            date: date,
                            exercise: exercise,
                            category: 'Cardio',
                            cardio: true,
                            distance: distance ? parseFloat(distance) : null,
                            duration: duration || null,
                            calories: calories ? parseInt(calories) : null,
                            zone2: zone2 === 'Yes',
                            norwegian: norwegian === 'Yes',
                            displayText: buildCardioDisplayText(distance, duration, calories)
                        };
                    }
                } else {
                    // Strength workout - group sets together
                    if (!workoutMap[key]) {
                        workoutMap[key] = {
                            date: date,
                            exercise: exercise,
                            category: category,
                            sets: []
                        };
                    }
                    
                    // Add this set to the array
                    if (weight) {
                        workoutMap[key].sets.push(parseFloat(weight));
                    } else {
                        workoutMap[key].sets.push('BW');
                    }
                }
            }
            
            console.log(`üìä Parsed ${totalRowsParsed} rows, skipped ${skippedRows} rows`);
            console.log(`üìä Grouped into ${Object.keys(workoutMap).length} unique workout entries`);
            
            // Convert map to array
            return Object.values(workoutMap);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function buildCardioDisplayText(distance, duration, calories) {
            let parts = [];
            
            // Add distance if available
            if (distance && distance > 0) {
                parts.push(`${distance} mi`);
            }
            
            // Add duration if available (remove seconds if it's exactly :00)
            if (duration) {
                // Clean up duration format (e.g., "60:00:00" -> "60:00")
                let cleanDuration = duration.toString();
                if (cleanDuration.endsWith(':00') && cleanDuration.length > 5) {
                    cleanDuration = cleanDuration.substring(0, cleanDuration.length - 3);
                }
                parts.push(cleanDuration);
            }
            
            // Add calories if available
            if (calories && calories > 0) {
                parts.push(`${calories} cals`);
            }
            
            // If no data at all, return a helpful message
            if (parts.length === 0) {
                return 'Workout completed';
            }
            
            return parts.join(', ');
        }

        // Get workouts for stats (use real data if loaded, otherwise demo)
        function getWorkoutsForStats() {
            return dataLoaded ? REAL_WORKOUTS : DEMO_WORKOUTS;
        }

        // Status Management Functions
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            // Check if elements exist (they might not be loaded yet)
            if (!indicator || !statusText) {
                console.log('‚ö†Ô∏è Status elements not ready yet, status:', status);
                return;
            }
            
            indicator.className = 'status-indicator';
            
            if (status === 'connected') {
                indicator.classList.add('status-connected');
                statusText.textContent = text || 'Connected';
            } else if (status === 'local') {
                indicator.classList.add('status-local');
                statusText.textContent = text || 'Local Only';
            } else if (status === 'error') {
                indicator.classList.add('status-error');
                statusText.textContent = text || 'Connection Error';
            } else if (status === 'loading') {
                indicator.classList.add('status-local');
                statusText.textContent = text || 'Loading...';
            }
        }

        function showErrorBanner(message) {
            const banner = document.getElementById('errorBanner');
            const messageEl = document.getElementById('errorMessage');
            
            if (!banner || !messageEl) return; // Safety check
            
            messageEl.textContent = message;
            banner.classList.add('show');
        }

        function hideErrorBanner() {
            const banner = document.getElementById('errorBanner');
            if (!banner) return; // Safety check
            banner.classList.remove('show');
        }

        function showWarningBanner(message) {
            const banner = document.getElementById('warningBanner');
            const messageEl = document.getElementById('warningMessage');
            
            if (!banner || !messageEl) return; // Safety check
            
            messageEl.textContent = message;
            banner.classList.add('show');
        }

        function hideWarningBanner() {
            const banner = document.getElementById('warningBanner');
            if (!banner) return; // Safety check
            banner.classList.remove('show');
        }

        function retryConnection() {
            hideErrorBanner();
            loadWorkoutDataFromSheet();
        }

        function viewPendingUploads() {
            // Scroll to pending uploads section
            const pending = document.getElementById('pendingUploads');
            if (pending) {
                pending.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function retryAllUploads() {
            showMessage('‚è≥ Retry feature coming in Phase 2!', 'info');
        }

        // Tab Switching
        let currentTab = 'today';
        let currentStatsPeriod = 'week';

        function switchTab(tabName) {
            // Update current tab
            currentTab = tabName;
            
            // Hide all tab contents
            document.getElementById('todayContent').classList.remove('active');
            document.getElementById('statsContent').classList.remove('active');
            
            // Remove active class from all tab buttons
            document.getElementById('todayTab').classList.remove('active');
            document.getElementById('statsTab').classList.remove('active');
            
            // Show selected tab content and activate button
            if (tabName === 'today') {
                document.getElementById('todayContent').classList.add('active');
                document.getElementById('todayTab').classList.add('active');
            } else if (tabName === 'stats') {
                document.getElementById('statsContent').classList.add('active');
                document.getElementById('statsTab').classList.add('active');
                // Render current stats period when switching to stats tab
                renderStatsPeriod(currentStatsPeriod);
            }
        }

        function showStatsPeriod(period) {
            // Update current period
            currentStatsPeriod = period;
            
            // Remove active class from all period buttons
            document.getElementById('weekBtn').classList.remove('active');
            document.getElementById('monthBtn').classList.remove('active');
            document.getElementById('yearBtn').classList.remove('active');
            document.getElementById('lifetimeBtn').classList.remove('active');
            document.getElementById('recordsBtn').classList.remove('active');
            
            // Activate selected button
            document.getElementById(period + 'Btn').classList.add('active');
            
            // Render the stats for this period
            renderStatsPeriod(period);
        }

        function renderStatsPeriod(period) {
            const display = document.getElementById('statsDataDisplay');
            
            // Check data source
            const dataSource = dataLoaded ? 
                `<div style="background: #4caf50; color: white; padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-size: 13px;">
                    ‚úì Using Real Data (${REAL_WORKOUTS.length} workout entries loaded)
                </div>` :
                `<div style="background: #ff9800; color: white; padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-size: 13px;">
                    ‚ö†Ô∏è Using Demo Data (Real data failed to load)
                </div>`;
            
            // Calculate stats based on period
            let stats;
            let title = '';
            let trainingBalanceHTML = '';
            
            if (period === 'week') {
                stats = calculateWeekStats();
                title = 'üìÖ This Week';
                trainingBalanceHTML = `
                    <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üí™ Training Balance (Last 7 Days)</h4>
                        ${renderBodyPartBalance(7)}
                    </div>
                `;
            } else if (period === 'month') {
                stats = calculateMonthStats();
                title = 'üìÜ This Month';
                trainingBalanceHTML = `
                    <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üí™ Training Balance (Last 30 Days)</h4>
                        ${renderBodyPartBalance(30)}
                    </div>
                `;
            } else if (period === 'year') {
                stats = calculateYearStats();
                title = 'üìà This Year';
                trainingBalanceHTML = `
                    <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üí™ Training Balance (This Calendar Year)</h4>
                        ${renderBodyPartBalanceForYear()}
                    </div>
                `;
            } else if (period === 'lifetime') {
                stats = calculateLifetimeStats();
                title = 'üèÜ Lifetime Stats';
                trainingBalanceHTML = ''; // No training balance for lifetime
            } else if (period === 'records') {
                // Personal Records view - no stats calculation needed
                display.innerHTML = `
                    ${dataSource}
                    <h3 style="color: var(--info-text); margin-bottom: 20px;">üèÜ Personal Records</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                        Maximum weight lifted for each exercise across your entire training history.
                    </p>
                    ${renderAllPRs()}
                `;
                return; // Exit early, no need for standard stats rendering
            }
            
            // Render the stats
            display.innerHTML = `
                ${dataSource}
                <h3 style="color: var(--info-text); margin-bottom: 20px;">${title}</h3>
                
                <!-- Training Balance Section (conditional based on period) -->
                ${trainingBalanceHTML}
                
                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">üí™ Strength Training</h4>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Workouts: <strong style="color: var(--text-primary);">${stats.strength.workouts}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Total Sets: <strong style="color: var(--text-primary);">${stats.strength.totalSets}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Est. Volume: <strong style="color: var(--text-primary);">${stats.strength.volume.toLocaleString()} lbs</strong></p>
                    ${stats.strength.topExercise ? `<p style="color: var(--text-secondary); margin: 5px 0;">Top Exercise: <strong style="color: var(--text-primary);">${stats.strength.topExercise}</strong></p>` : ''}
                </div>
                
                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">üèÉ Cardio</h4>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Sessions: <strong style="color: var(--text-primary);">${stats.cardio.sessions}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Total Miles: <strong style="color: var(--text-primary);">${stats.cardio.miles.toFixed(1)}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Calories: <strong style="color: var(--text-primary);">${stats.cardio.calories.toLocaleString()}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Zone 2: <strong style="color: var(--text-primary);">${stats.cardio.zone2Count} sessions</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Norwegian: <strong style="color: var(--text-primary);">${stats.cardio.norwegianCount} sessions</strong></p>
                </div>
                
                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">üìä Overall</h4>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Total Workouts: <strong style="color: var(--text-primary);">${stats.overall.totalWorkouts}</strong></p>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Most Trained: <strong style="color: var(--text-primary);">${stats.overall.topCategory}</strong></p>
                </div>
            `;
        }

        function renderPRs() {
            const prs = findPersonalRecords();
            
            // Group by category
            const groupedPRs = {};
            Object.keys(prs).forEach(exercise => {
                const category = prs[exercise].category;
                if (!groupedPRs[category]) groupedPRs[category] = [];
                groupedPRs[category].push({
                    exercise: exercise,
                    ...prs[exercise]
                });
            });
            
            let html = '';
            
            // Display PRs by category
            Object.keys(groupedPRs).sort().forEach(category => {
                const categoryEmoji = {
                    'Chest': 'üí™',
                    'Back': 'üîô',
                    'Arms': 'üí™',
                    'Shoulders': '‚≠ê',
                    'Legs': 'ü¶µ',
                    'Core': 'üî•'
                }[category] || 'üí™';
                
                html += `<div style="margin-bottom: 15px;">`;
                html += `<h5 style="color: var(--info-text); margin-bottom: 8px; font-size: 14px;">${categoryEmoji} ${category}</h5>`;
                
                groupedPRs[category].forEach(pr => {
                    const isNew = isNewPR(pr.date);
                    const prBadge = isNew ? ' <span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;">üî• NEW PR!</span>' : '';
                    
                    html += `<p style="color: var(--text-secondary); margin: 4px 0; font-size: 13px;">
                        ${pr.exercise}: <strong style="color: var(--text-primary);">${pr.weight} lbs</strong> 
                        <span style="color: var(--text-light); font-size: 11px;">(${pr.date})</span>${prBadge}
                    </p>`;
                });
                
                html += `</div>`;
            });
            
            return html || '<p style="color: var(--text-secondary); font-size: 13px;">No PRs recorded yet.</p>';
        }

        function renderAllPRs() {
            const prsWithFrequency = findPersonalRecordsWithFrequency();
            
            // Group by category
            const groupedPRs = {};
            Object.keys(prsWithFrequency).forEach(exercise => {
                const category = prsWithFrequency[exercise].category;
                if (!groupedPRs[category]) groupedPRs[category] = [];
                groupedPRs[category].push({
                    exercise: exercise,
                    ...prsWithFrequency[exercise]
                });
            });
            
            let html = '';
            
            // Category order and emojis
            const categoryOrder = ['Arms', 'Chest', 'Back', 'Shoulders', 'Legs', 'Core', 'Other'];
            const categoryEmojis = {
                'Arms': 'üí™',
                'Chest': 'üèãÔ∏è',
                'Back': 'üîô',
                'Shoulders': '‚≠ê',
                'Legs': 'ü¶µ',
                'Core': 'üî•',
                'Other': 'üîß'
            };
            
            // Display PRs by category in order
            categoryOrder.forEach(category => {
                if (!groupedPRs[category]) return;
                
                const emoji = categoryEmojis[category] || 'üí™';
                
                html += `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 15px; font-size: 16px; font-weight: 600;">${emoji} ${category}</h4>
                `;
                
                // Sort exercises alphabetically within category
                groupedPRs[category].sort((a, b) => a.exercise.localeCompare(b.exercise));
                
                groupedPRs[category].forEach(pr => {
                    // Format frequency text
                    let frequencyText = '';
                    if (pr.count > 1) {
                        if (pr.count >= 10) {
                            frequencyText = `<span style="color: #4caf50; font-weight: 600;">10+</span>`;
                        } else if (pr.count >= 5) {
                            frequencyText = `<span style="color: #4caf50; font-weight: 600;">5+</span>`;
                        } else {
                            frequencyText = `<span style="color: var(--info-text);">${pr.count}√ó</span>`;
                        }
                    }
                    
                    html += `
                    <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--info-text);">
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;">
                            <span style="color: var(--text-primary); font-size: 14px; font-weight: 500;">${pr.exercise}</span>
                            <span style="color: var(--text-primary); font-size: 16px; font-weight: 700;">${pr.weight} lbs</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-light); font-size: 12px;">${pr.mostRecentDate}</span>
                            ${frequencyText ? `<span style="font-size: 12px;">${frequencyText}</span>` : ''}
                        </div>
                    </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            return html || '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No personal records found.</p>';
        }

        function findPersonalRecordsWithFrequency() {
            const workouts = getWorkoutsForStats();
            const prs = {};
            
            workouts.forEach(workout => {
                // Skip cardio
                if (workout.cardio) return;
                
                const exercise = workout.exercise;
                const category = workout.category || 'Other';
                
                // Check each set
                if (workout.sets && Array.isArray(workout.sets)) {
                    workout.sets.forEach(weight => {
                        if (typeof weight === 'number') {
                            if (!prs[exercise]) {
                                prs[exercise] = {
                                    weight: weight,
                                    category: category,
                                    mostRecentDate: workout.date,
                                    count: 1,
                                    dates: [workout.date]
                                };
                            } else if (weight > prs[exercise].weight) {
                                // New PR!
                                prs[exercise].weight = weight;
                                prs[exercise].mostRecentDate = workout.date;
                                prs[exercise].count = 1;
                                prs[exercise].dates = [workout.date];
                            } else if (weight === prs[exercise].weight) {
                                // Same PR, update count and most recent date
                                prs[exercise].count++;
                                if (!prs[exercise].dates.includes(workout.date)) {
                                    prs[exercise].dates.push(workout.date);
                                }
                                // Update most recent date if this one is more recent
                                const currentDate = new Date(prs[exercise].mostRecentDate);
                                const newDate = new Date(workout.date);
                                if (newDate > currentDate) {
                                    prs[exercise].mostRecentDate = workout.date;
                                }
                            }
                        }
                    });
                }
            });
            
            return prs;
        }

        function renderBodyPartBalance(days) {
            const data = calculateBodyPartBalance(days);
            return renderBodyPartBalanceHelper(data);
        }

        // Stats Calculation Functions
        function calculateWeekStats() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            return calculateStatsForPeriod(weekAgo, today);
        }

        function calculateMonthStats() {
            const today = new Date();
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            return calculateStatsForPeriod(monthAgo, today);
        }

        function calculateYearStats() {
            const today = new Date();
            const yearAgo = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
            return calculateStatsForPeriod(yearAgo, today);
        }

        function calculateLifetimeStats() {
            // For demo, use all data
            const earliest = new Date('2022-01-01');
            const today = new Date();
            return calculateStatsForPeriod(earliest, today);
        }

        function calculateStatsForPeriod(startDate, endDate) {
            // Filter workouts within date range
            const workouts = getWorkoutsForStats().filter(w => {
                const workoutDate = new Date(w.date);
                return workoutDate >= startDate && workoutDate <= endDate;
            });

            // Initialize stats
            const stats = {
                strength: {
                    workouts: 0,
                    totalSets: 0,
                    volume: 0,
                    topExercise: ''
                },
                cardio: {
                    sessions: 0,
                    miles: 0,
                    calories: 0,
                    zone2Count: 0,
                    norwegianCount: 0
                },
                overall: {
                    totalWorkouts: 0,
                    topCategory: ''
                }
            };

            // Count categories and exercises
            const categoryCount = {};
            const exerciseCount = {};
            const uniqueDates = new Set();

            workouts.forEach(w => {
                uniqueDates.add(w.date);

                if (w.category === 'Cardio') {
                    stats.cardio.sessions++;
                    stats.cardio.miles += w.distance || 0;
                    stats.cardio.calories += w.calories || 0;
                    if (w.zone2) stats.cardio.zone2Count++;
                    if (w.norwegian) stats.cardio.norwegianCount++;
                } else {
                    // Strength training
                    if (w.sets && Array.isArray(w.sets)) {
                        stats.strength.totalSets += w.sets.length;
                        
                        // Calculate volume (assume 8 reps per set)
                        w.sets.forEach(weight => {
                            if (weight !== 'BW' && !isNaN(weight)) {
                                stats.strength.volume += parseFloat(weight) * 8;
                            }
                        });
                    }

                    // Count exercise frequency
                    exerciseCount[w.exercise] = (exerciseCount[w.exercise] || 0) + 1;
                }

                // Count category frequency
                categoryCount[w.category] = (categoryCount[w.category] || 0) + 1;
            });

            // Calculate strength workouts (unique dates with strength exercises)
            stats.strength.workouts = workouts.filter(w => w.category !== 'Cardio').length > 0 ? 
                [...new Set(workouts.filter(w => w.category !== 'Cardio').map(w => w.date))].length : 0;

            // Find top exercise
            if (Object.keys(exerciseCount).length > 0) {
                stats.strength.topExercise = Object.keys(exerciseCount).reduce((a, b) => 
                    exerciseCount[a] > exerciseCount[b] ? a : b
                );
            }

            // Find top category
            if (Object.keys(categoryCount).length > 0) {
                stats.overall.topCategory = Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b
                );
            }

            stats.overall.totalWorkouts = uniqueDates.size;

            return stats;
        }

        // Personal Records (PRs) Detection
        function findPersonalRecords() {
            const prs = {};
            
            getWorkoutsForStats().forEach(w => {
                if (w.category !== 'Cardio' && w.sets && Array.isArray(w.sets)) {
                    w.sets.forEach(weight => {
                        if (weight !== 'BW' && !isNaN(weight)) {
                            const numWeight = parseFloat(weight);
                            
                            if (!prs[w.exercise]) {
                                prs[w.exercise] = {
                                    weight: numWeight,
                                    date: w.date,
                                    category: w.category
                                };
                            } else if (numWeight > prs[w.exercise].weight) {
                                prs[w.exercise] = {
                                    weight: numWeight,
                                    date: w.date,
                                    category: w.category
                                };
                            }
                        }
                    });
                }
            });
            
            return prs;
        }

        function isNewPR(prDate) {
            const pr = new Date(prDate);
            const today = new Date();
            const daysDiff = (today - pr) / (1000 * 60 * 60 * 24);
            return daysDiff <= 7;
        }

        // Body Part Balance Calculation
        function calculateBodyPartBalance(days) {
            const today = new Date();
            const startDate = new Date(today.getTime() - days * 24 * 60 * 60 * 1000);
            
            const categorySetCounts = {
                'Chest': 0,
                'Back': 0,
                'Arms': 0,
                'Shoulders': 0,
                'Legs': 0,
                'Core': 0,
                'Other': 0
            };
            
            getWorkoutsForStats().forEach(w => {
                const workoutDate = new Date(w.date);
                if (workoutDate >= startDate && workoutDate <= today) {
                    if (w.category !== 'Cardio' && w.sets && Array.isArray(w.sets)) {
                        const category = w.category;
                        if (categorySetCounts.hasOwnProperty(category)) {
                            categorySetCounts[category] += w.sets.length;
                        } else {
                            categorySetCounts['Other'] += w.sets.length;
                        }
                    }
                }
            });
            
            // Find max for scaling progress bars
            const maxSets = Math.max(...Object.values(categorySetCounts));
            
            return {
                counts: categorySetCounts,
                maxSets: maxSets
            };
        }

        // Body Part Balance for Calendar Year (not rolling 365 days)
        function calculateBodyPartBalanceForYear() {
            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1); // January 1st of current year
            
            const categorySetCounts = {
                'Chest': 0,
                'Back': 0,
                'Arms': 0,
                'Shoulders': 0,
                'Legs': 0,
                'Core': 0,
                'Other': 0
            };
            
            getWorkoutsForStats().forEach(w => {
                const workoutDate = new Date(w.date);
                if (workoutDate >= yearStart && workoutDate <= today) {
                    if (w.category !== 'Cardio' && w.sets && Array.isArray(w.sets)) {
                        const category = w.category;
                        if (categorySetCounts.hasOwnProperty(category)) {
                            categorySetCounts[category] += w.sets.length;
                        } else {
                            categorySetCounts['Other'] += w.sets.length;
                        }
                    }
                }
            });
            
            // Find max for scaling progress bars
            const maxSets = Math.max(...Object.values(categorySetCounts));
            
            return {
                counts: categorySetCounts,
                maxSets: maxSets
            };
        }

        function renderBodyPartBalanceForYear() {
            const data = calculateBodyPartBalanceForYear();
            return renderBodyPartBalanceHelper(data);
        }

        function renderBodyPartBalanceHelper(data) {
            const categories = ['Chest', 'Back', 'Arms', 'Shoulders', 'Legs', 'Core', 'Other'];
            const emojis = {
                'Chest': 'üí™',
                'Back': 'üîô',
                'Arms': 'üí™',
                'Shoulders': 'ü§∑',
                'Legs': 'ü¶µ',
                'Core': 'üî•',
                'Other': 'üèãÔ∏è'
            };
            
            let html = '';
            
            categories.forEach(cat => {
                const count = data.counts[cat];
                const percentage = data.maxSets > 0 ? (count / data.maxSets * 100) : 0;
                
                // Badges
                let badges = '';
                if (count === data.maxSets && count > 0) {
                    badges = '<span style="background: #ff5252; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;">üî•</span>';
                } else if (percentage < 30 && data.maxSets > 0) {
                    badges = '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;">‚ö†Ô∏è</span>';
                }
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="color: var(--text-primary); font-weight: 500; font-size: 14px;">${emojis[cat]} ${cat} ${badges}</span>
                            <span style="color: var(--text-secondary); font-size: 13px;">${count} sets</span>
                        </div>
                        <div style="background: var(--border-color); border-radius: 10px; height: 8px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #2196F3, #64B5F6); width: ${percentage}%; height: 100%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function changeDatePicker() {
            const picker = document.getElementById('datePicker');
            
            // Set current date as default
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            picker.value = `${year}-${month}-${day}`;
            
            // Trigger the date picker
            picker.style.opacity = '1';
            picker.style.pointerEvents = 'auto';
            picker.focus();
            picker.click();
            
            // Listen for date change
            picker.onchange = function() {
                if (picker.value) {
                    const parts = picker.value.split('-');
                    currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    document.getElementById('currentDate').textContent = formatDate(currentDate);
                    loadTodaysWorkouts();
                }
                // Hide picker again
                picker.style.opacity = '0';
                picker.style.pointerEvents = 'none';
            };
        }

        function showCategory(category) {
            selectedCategory = category;
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = '';
            grid.classList.remove('hidden');
            
            EXERCISES[category].forEach(exercise => {
                const btn = document.createElement('button');
                btn.className = 'exercise-btn';
                btn.textContent = exercise;
                btn.onclick = () => selectExercise(exercise, category);
                grid.appendChild(btn);
            });

            // Highlight active category
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function selectExercise(exercise, category) {
            selectedExercise = exercise;
            selectedCategory = category;
            
            // Clear previous exercise highlights
            document.querySelectorAll('.exercise-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Highlight the clicked exercise
            event.target.classList.add('selected');
            
            document.getElementById('selectedExercise').textContent = exercise;
            document.getElementById('inputSection').classList.remove('hidden');
            
            // Check if this is a cardio exercise
            const isCardio = category === 'Cardio';
            
            if (isCardio) {
                // Show cardio form, hide weight form
                document.getElementById('weightInput').classList.add('hidden');
                document.getElementById('cardioInput').classList.remove('hidden');
                
                // Clear cardio fields
                document.getElementById('cardioDuration').value = '';
                document.getElementById('cardioDistance').value = '';
                document.getElementById('cardioCalories').value = '';
                document.getElementById('cardioSpeed').value = '';
                document.getElementById('cardioNotes').value = '';
                document.getElementById('zone2Checkbox').checked = false;
                document.getElementById('norwegianSets').value = '';
                document.getElementById('norwegianMins').value = '';
                
                // Show/hide Norwegian rounds field based on exercise
                const norwegianField = document.getElementById('norwegianRoundsField');
                if (exercise === 'Norwegian Intervals') {
                    norwegianField.classList.remove('hidden');
                } else {
                    norwegianField.classList.add('hidden');
                }
                
                // Customize speed/level label based on exercise
                const speedLabel = document.getElementById('cardioSpeedLabel');
                const speedInput = document.getElementById('cardioSpeed');
                
                if (exercise === 'Stair Machine') {
                    speedLabel.textContent = 'Level:';
                    speedInput.placeholder = 'e.g., 8';
                } else if (exercise === 'Outdoor Run' || exercise === 'Outdoor Hike') {
                    speedLabel.textContent = 'Pace:';
                    speedInput.placeholder = 'e.g., 7:30/mi';
                } else {
                    speedLabel.textContent = 'Speed:';
                    speedInput.placeholder = 'e.g., 6.5';
                }
                
                // Focus on duration field (or rounds if Norwegian)
                setTimeout(() => {
                    if (exercise === 'Norwegian Intervals') {
                        document.getElementById('norwegianSets').focus();
                    } else {
                        document.getElementById('cardioDuration').focus();
                    }
                }, 100);
                
            } else {
                // Show weight form, hide cardio form
                document.getElementById('weightInput').classList.remove('hidden');
                document.getElementById('cardioInput').classList.add('hidden');
                
                // Clear weight fields
                document.getElementById('quickEntry').value = '';
                document.getElementById('setInputs').innerHTML = '';
                setCounter = 0;
                
                // Add 4 empty sets by default
                for (let i = 0; i < 4; i++) {
                    addEmptySet();
                }
                
                // Focus on first weight input
                setTimeout(() => {
                    const firstInput = document.querySelector('#setInputs input');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
            
            // Load previous workout data for this exercise
            loadPreviousData(exercise);
        }

        function loadPreviousData(exercise) {
            previousWorkoutsToShow = 3; // Reset to 3 when selecting new exercise
            const prevData = document.getElementById('previousData');
            prevData.classList.remove('hidden');
            prevData.innerHTML = `
                <strong>üìä Loading previous workouts...</strong>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Checking your workout history...
                </div>
            `;
            
            // Fetch from Google Sheets
            fetchPreviousWorkouts(exercise);
        }

        async function fetchPreviousWorkouts(exercise) {
            try {
                console.log('üìä Fetching previous workouts for:', exercise);
                
                // Filter REAL_WORKOUTS for this specific exercise
                const exerciseHistory = REAL_WORKOUTS.filter(workout => 
                    workout.exercise === exercise
                );
                
                console.log('üìà Found', exerciseHistory.length, 'previous workouts');
                
                if (exerciseHistory.length === 0) {
                    document.getElementById('previousData').innerHTML = `
                        <strong>üìä First time doing this exercise!</strong>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            No previous data found
                        </div>
                    `;
                    return;
                }
                
                // Check if this is cardio or strength
                const isCardio = exerciseHistory[0].cardio === true;
                
                // Format workouts for display
                const workouts = exerciseHistory.map(entry => {
                    if (isCardio) {
                        // Cardio workout - return with cardio metrics
                        return {
                            date: entry.date,
                            cardio: true,
                            distance: entry.distance,
                            duration: entry.duration,
                            calories: entry.calories,
                            zone2: entry.zone2 || false,
                            displayText: entry.displayText || buildCardioDisplayText(entry.distance, entry.duration, entry.calories)
                        };
                    } else {
                        // Strength workout - return with sets
                        return {
                            date: entry.date,
                            cardio: false,
                            sets: entry.sets || []
                        };
                    }
                }).sort((a, b) => {
                    // Sort by date (newest first)
                    return new Date(b.date) - new Date(a.date);
                });
                
                console.log('üìÖ Found', workouts.length, 'workout days');
                console.log('üìä Sample workout:', workouts[0]);
                
                displayPreviousWorkouts(workouts);
                
            } catch (error) {
                console.error('‚ùå Error fetching previous data:', error);
                document.getElementById('previousData').innerHTML = `
                    <strong>‚ö†Ô∏è Could not load previous data</strong>
                    <div style="font-size: 12px;">Continue with your workout!</div>
                `;
            }
        }

        function displayPreviousWorkouts(workouts) {
            const prevData = document.getElementById('previousData');
            
            if (!workouts || workouts.length === 0) {
                prevData.innerHTML = `
                    <strong>üìä First time doing this exercise!</strong>
                    <div>No previous data found</div>
                `;
                return;
            }
            
            // Show only the number requested
            const workoutsToDisplay = workouts.slice(0, previousWorkoutsToShow);
            const hasMore = workouts.length > previousWorkoutsToShow;
            const canShowMore = previousWorkoutsToShow < 9 && hasMore;
            
            let html = '<strong>üìä Previous Workouts:</strong><div style="margin-top: 10px;">';
            
            workoutsToDisplay.forEach(workout => {
                // Check if cardio or strength
                if (workout.cardio) {
                    // Display cardio metrics with optional Zone 2 badge
                    const zone2Badge = workout.zone2 ? '<span style="display: inline-block; background: #4caf50; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: bold;">üíö Zone 2</span>' : '';
                    html += `
                        <div class="workout-history-item">
                            <div class="date">${workout.date}${zone2Badge}</div>
                            <div class="sets">${workout.displayText || 'Workout completed'}</div>
                        </div>
                    `;
                } else {
                    // Display strength metrics (sets and weights)
                    html += `
                        <div class="workout-history-item">
                            <div class="date">${workout.date}</div>
                            <div class="sets">${workout.sets.length} sets @ ${workout.sets.join('/')}</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            // Add "Show More" button if there are more workouts
            if (canShowMore) {
                const remaining = Math.min(3, workouts.length - previousWorkoutsToShow);
                html += `<button class="show-more-btn" onclick="showMoreWorkouts()">Show ${remaining} More...</button>`;
            }
            
            prevData.innerHTML = html;
        }

        function showMoreWorkouts() {
            // Increase by 3
            previousWorkoutsToShow += 3;
            
            // Re-fetch and display (in production, this would use cached data)
            fetchPreviousWorkouts(selectedExercise);
        }

        // ============================================================================
        // WORKOUT FLASHBACK FUNCTIONS
        // ============================================================================

        function loadWorkoutFlashback() {
            if (!REAL_WORKOUTS || REAL_WORKOUTS.length === 0) {
                console.log('‚ö†Ô∏è No workout data available for flashback');
                return;
            }

            console.log('üìÖ Loading Workout Flashback...');

            // Group workouts by date (excluding today)
            const today = formatDateForSheet(currentDate);
            const workoutsByDate = {};

            REAL_WORKOUTS.forEach(workout => {
                const date = workout.date;
                
                // Skip today's workouts
                if (date === today) return;
                
                if (!workoutsByDate[date]) {
                    workoutsByDate[date] = [];
                }
                workoutsByDate[date].push(workout);
            });

            // Convert to array and sort by date (newest first)
            flashbackWorkouts = Object.entries(workoutsByDate)
                .map(([date, exercises]) => ({
                    date: date,
                    exercises: exercises,
                    exerciseCount: exercises.length
                }))
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10); // Max 10 workouts

            console.log(`‚úÖ Found ${flashbackWorkouts.length} previous workout days`);
            
            renderFlashbackWorkouts();
        }

        function renderFlashbackWorkouts() {
            const container = document.getElementById('flashbackContainer');
            const showMoreBtn = document.getElementById('flashbackShowMore');

            if (flashbackWorkouts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No previous workouts found</p>';
                showMoreBtn.style.display = 'none';
                return;
            }

            // Show only the first N workouts
            const workoutsToShow = flashbackWorkouts.slice(0, flashbackWorkoutsShown);
            
            container.innerHTML = workoutsToShow.map((workout, index) => {
                const daysAgo = getDaysAgo(workout.date);
                const daysAgoText = daysAgo === 0 ? 'Today' : 
                                   daysAgo === 1 ? 'Yesterday' : 
                                   `${daysAgo} days ago`;

                return `
                    <div class="flashback-card" id="flashback-${index}">
                        <div class="flashback-header" onclick="toggleFlashbackCard(${index})">
                            <div class="flashback-header-info">
                                <div class="flashback-date">${workout.date}</div>
                                <div class="flashback-meta">${daysAgoText} ‚Ä¢ ${workout.exerciseCount} exercises</div>
                            </div>
                            <div class="flashback-expand-icon">‚ñº</div>
                        </div>
                        <div class="flashback-content">
                            <div class="flashback-exercises">
                                ${renderFlashbackExercises(workout.exercises)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show/hide "Show More" button
            if (flashbackWorkoutsShown < flashbackWorkouts.length) {
                showMoreBtn.style.display = 'block';
            } else {
                showMoreBtn.style.display = 'none';
            }
        }

        function renderFlashbackExercises(exercises) {
            // Group exercises by name (since each set is a separate entry)
            const exerciseMap = {};

            exercises.forEach(ex => {
                if (!exerciseMap[ex.exercise]) {
                    exerciseMap[ex.exercise] = {
                        name: ex.exercise,
                        cardio: ex.cardio,
                        sets: [],
                        distance: ex.distance,
                        duration: ex.duration,
                        calories: ex.calories,
                        zone2: ex.zone2
                    };
                }
                
                // Add sets for strength exercises
                if (ex.sets && ex.sets.length > 0) {
                    exerciseMap[ex.exercise].sets.push(...ex.sets);
                }
            });

            // Render each exercise
            return Object.values(exerciseMap).map(exercise => {
                let dataDisplay = '';
                
                if (exercise.cardio) {
                    // Cardio display
                    const parts = [];
                    if (exercise.distance) parts.push(`${exercise.distance} mi`);
                    if (exercise.duration) {
                        let cleanDuration = exercise.duration.toString();
                        if (cleanDuration.endsWith(':00') && cleanDuration.length > 5) {
                            cleanDuration = cleanDuration.substring(0, cleanDuration.length - 3);
                        }
                        parts.push(cleanDuration);
                    }
                    if (exercise.calories) parts.push(`${exercise.calories} cals`);
                    dataDisplay = parts.join(', ') || 'Workout completed';
                    
                    if (exercise.zone2) {
                        dataDisplay += ' <span style="background: #4caf50; color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; margin-left: 5px;">üíö Z2</span>';
                    }
                } else {
                    // Strength display
                    if (exercise.sets.length > 0) {
                        dataDisplay = `${exercise.sets.length} sets @ ${exercise.sets.join('/')}`;
                    } else {
                        dataDisplay = 'Completed';
                    }
                }

                return `
                    <div class="flashback-exercise">
                        <div class="flashback-exercise-name">${exercise.name}</div>
                        <div class="flashback-exercise-data">${dataDisplay}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleFlashbackCard(index) {
            const card = document.getElementById(`flashback-${index}`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function showMoreFlashbacks() {
            flashbackWorkoutsShown = Math.min(flashbackWorkoutsShown + 1, 10);
            renderFlashbackWorkouts();
        }

        function getDaysAgo(dateString) {
            const workoutDate = new Date(dateString);
            const today = new Date(currentDate);
            
            // Reset time to midnight for accurate day comparison
            workoutDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const diffTime = today - workoutDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // ============================================================================
        // END WORKOUT FLASHBACK FUNCTIONS
        // ============================================================================

        document.getElementById('quickEntry').addEventListener('input', function(e) {
            const value = e.target.value;
            if (value.includes('@')) {
                parseQuickEntry(value);
            }
        });

        function parseQuickEntry(input) {
            const setInputs = document.getElementById('setInputs');
            setInputs.innerHTML = '';
            setCounter = 0;
            
            // Check if just a number (e.g., "4" = 4 sets, no weight)
            if (/^\d+$/.test(input)) {
                const numSets = parseInt(input);
                for (let i = 0; i < numSets; i++) {
                    addSetRow('');
                }
                return;
            }
            
            // Parse formats like "4@50" or "4@25/30/35/40"
            const match = input.match(/(\d+)@(.+)/);
            if (!match) return;
            
            const numSets = parseInt(match[1]);
            const weights = match[2].split('/').map(w => w.trim());
            
            for (let i = 0; i < numSets; i++) {
                const weight = weights.length === 1 ? weights[0] : (weights[i] || '');
                addSetRow(weight);
            }
        }

        function addEmptySet() {
            addSetRow('');
        }

        function addSetRow(weight = '') {
            setCounter++;
            const setInputs = document.getElementById('setInputs');
            const row = document.createElement('div');
            row.className = 'set-row';
            row.id = `set-${setCounter}`;
            row.innerHTML = `
                <span>Set ${setCounter}</span>
                <input type="number" step="0.5" placeholder="Weight (lbs)" value="${weight}" data-set="${setCounter}">
                <button class="btn-secondary" onclick="removeSet(${setCounter})">‚úï</button>
            `;
            setInputs.appendChild(row);
        }

        function removeSet(setNum) {
            const row = document.getElementById(`set-${setNum}`);
            if (row) {
                row.remove();
                renumberSets();
            }
        }

        function renumberSets() {
            const rows = document.querySelectorAll('.set-row');
            setCounter = 0;
            rows.forEach((row, index) => {
                setCounter++;
                row.id = `set-${setCounter}`;
                const label = row.querySelector('span');
                const button = row.querySelector('button');
                if (label) {
                    label.textContent = `Set ${index + 1}`;
                }
                if (button) {
                    button.onclick = () => removeSet(setCounter);
                }
            });
        }

        async function submitWorkout() {
            if (!selectedExercise) return;
            
            const isCardio = selectedCategory === 'Cardio';
            let workoutData = {};
            
            if (isCardio) {
                // Collect cardio data
                const duration = document.getElementById('cardioDuration').value.trim();
                const distance = document.getElementById('cardioDistance').value.trim();
                const calories = document.getElementById('cardioCalories').value.trim();
                const speed = document.getElementById('cardioSpeed').value.trim();
                const zone2 = document.getElementById('zone2Checkbox').checked;
                const norwegianSets = document.getElementById('norwegianSets').value.trim();
                const norwegianMins = document.getElementById('norwegianMins').value.trim();
                const notes = document.getElementById('cardioNotes').value.trim();
                
                // Check if this is Norwegian Intervals
                const isNorwegian = selectedExercise === 'Norwegian Intervals';
                
                // Build notes field (include Norwegian rounds if applicable)
                let finalNotes = notes;
                if (isNorwegian && norwegianSets && norwegianMins) {
                    const roundsText = `${norwegianSets}x${norwegianMins}`;
                    finalNotes = finalNotes ? `${roundsText} - ${notes}` : roundsText;
                }
                
                workoutData = {
                    date: formatDateForSheet(currentDate),
                    exercise: selectedExercise,
                    category: 'Cardio',
                    distance: distance,
                    duration: duration,
                    calories: calories,
                    speed_pace: speed,
                    zone_2: zone2 ? 'Yes' : 'No',
                    norwegian_sprints: isNorwegian ? 'Yes' : 'No',
                    notes: finalNotes
                };
                
                // Build display text for summary
                const displayParts = [];
                if (duration) displayParts.push(duration);
                if (distance) displayParts.push(`${distance} mi`);
                if (calories) displayParts.push(`${calories} cal`);
                
                todaysWorkouts.push({
                    exercise: selectedExercise,
                    cardio: true,
                    displayText: displayParts.join(', '),
                    zone2: zone2,
                    norwegian: isNorwegian
                });
                
            } else {
                // Weight training - check individual boxes FIRST, then quick entry
                const inputs = Array.from(document.querySelectorAll('#setInputs input'));
                const boxValues = inputs
                    .map(input => input.value.trim())
                    .filter(val => val !== '');
                
                let sets = [];
                
                // Priority 1: If ANY boxes have values, use those
                if (boxValues.length > 0) {
                    sets = boxValues;
                } else {
                    // Priority 2: Fall back to quick entry if boxes are empty
                    const quickEntryValue = document.getElementById('quickEntry').value.trim();
                    
                    if (quickEntryValue) {
                        // Parse the quick entry
                        if (/^\d+$/.test(quickEntryValue)) {
                            const numSets = parseInt(quickEntryValue);
                            sets = new Array(numSets).fill('BW');
                        } else if (quickEntryValue.includes('@')) {
                            const match = quickEntryValue.match(/(\d+)@(.+)/);
                            if (match) {
                                const numSets = parseInt(match[1]);
                                const weights = match[2].split('/').map(w => w.trim());
                                
                                for (let i = 0; i < numSets; i++) {
                                    const weight = weights.length === 1 ? weights[0] : (weights[i] || '');
                                    sets.push(weight);
                                }
                            }
                        }
                    }
                }
                
                if (sets.length === 0) {
                    showMessage('Please enter workout data!', 'error');
                    return;
                }
                
                workoutData = {
                    date: formatDateForSheet(currentDate),
                    exercise: selectedExercise,
                    category: selectedCategory,
                    sets: sets
                };
                
                const displaySets = sets.map(s => s === 'BW' ? '' : s).filter(s => s !== '');
                todaysWorkouts.push({
                    exercise: selectedExercise,
                    sets: sets,
                    displaySets: displaySets.length > 0 ? displaySets : ['bodyweight']
                });
            }
            
            showSubmitMessage('Saving to Google Sheets...', 'loading');
            
            try {
                // Write to Google Sheets
                await writeWorkoutToSheet(workoutData);
                
                showSubmitMessage('‚úì Saved successfully!', 'success');
                
                // Reload data from sheets to refresh stats
                await loadWorkoutDataFromSheet();
                
                updateTodaysSummary();
                
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Reset form after a short delay so user can see success message
                setTimeout(() => {
                    document.getElementById('inputSection').classList.add('hidden');
                    document.getElementById('previousData').classList.add('hidden');
                    document.getElementById('quickEntry').value = '';
                    document.getElementById('setInputs').innerHTML = '';
                    document.getElementById('exerciseGrid').classList.add('hidden');
                    selectedExercise = null;
                    setCounter = 0;
                    
                    // Clear category selection
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Clear exercise selection
                    document.querySelectorAll('.exercise-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // Hide submit message
                    document.getElementById('submitMessage').classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error saving workout:', error);
                showSubmitMessage('‚ùå Error: ' + error.message, 'error');
            }
        }

        function showSubmitMessage(text, type) {
            const msg = document.getElementById('submitMessage');
            if (!msg) return;
            
            msg.className = type;
            msg.textContent = text;
            msg.classList.remove('hidden');
            
            // Auto-hide success/error messages after 5 seconds
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    msg.classList.add('hidden');
                }, 5000);
            }
        }

        async function writeWorkoutToSheet(workoutData) {
            try {
                // Check if we have a valid token
                if (!isTokenValid()) {
                    console.error('‚ùå No valid authentication token');
                    showAuthOverlay();
                    throw new Error('Please sign in with Google to save workouts');
                }
                
                console.log('üìù Writing workout to Google Sheets:', workoutData);
                console.log('üîë Using Spreadsheet ID:', SPREADSHEET_ID);
                console.log('üîë Access Token present:', accessToken ? 'Yes' : 'No');
                
                // Format data for each row (one row per set for strength, one row for cardio)
                const rows = [];
                
                if (workoutData.category === 'Cardio') {
                    // Single row for cardio
                    rows.push([
                        workoutData.date,              // Column A: Date
                        workoutData.exercise,          // Column B: Exercise
                        '',                            // Column C: Sets (empty for cardio)
                        '',                            // Column D: Reps (empty for cardio)
                        '',                            // Column E: Weight (empty for cardio)
                        workoutData.notes || '',       // Column F: Notes
                        'Cardio',                      // Column G: Category
                        workoutData.distance || '',    // Column H: Distance
                        workoutData.duration || '',    // Column I: Duration
                        workoutData.calories || '',    // Column J: Calories
                        workoutData.speed_pace || '',  // Column K: Speed_Pace
                        workoutData.zone_2 || 'No',    // Column L: Zone_2
                        workoutData.norwegian_sprints || 'No'  // Column M: Norwegian_Sprints
                    ]);
                } else {
                    // Multiple rows for strength training (one per set)
                    workoutData.sets.forEach(weight => {
                        rows.push([
                            workoutData.date,          // Column A: Date
                            workoutData.exercise,      // Column B: Exercise
                            '1',                       // Column C: Sets (always 1 per row)
                            '',                        // Column D: Reps (empty)
                            weight === 'BW' ? '' : weight,  // Column E: Weight
                            '',                        // Column F: Notes
                            workoutData.category,      // Column G: Category
                            '',                        // Column H: Distance
                            '',                        // Column I: Duration
                            '',                        // Column J: Calories
                            '',                        // Column K: Speed_Pace
                            '',                        // Column L: Zone_2
                            ''                         // Column M: Norwegian_Sprints
                        ]);
                    });
                }
                
                console.log('üìä Formatted rows to insert:', rows);
                
                // Append to bottom of sheet (most reliable, scalable method)
                const range = 'A:M'; // Append to columns A through M
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`;
                
                console.log('üåê Calling URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        values: rows
                    })
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Full error response:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: { message: errorText } };
                    }
                    
                    console.error('‚ùå Parsed API Error:', errorData);
                    
                    // Check if token expired
                    if (response.status === 401) {
                        console.error('‚ùå Token expired or invalid');
                        signOut();
                        throw new Error('Authentication expired. Please sign in again.');
                    }
                    
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Successfully wrote to sheet:', data);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error writing to sheet:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error; // Re-throw so the caller can handle it
            }
        }

        function loadTodaysWorkouts() {
            // This will load today's workouts from Google Sheets in production
            todaysWorkouts = [];
            updateTodaysSummary();
        }

        function updateTodaysSummary() {
            const summary = document.getElementById('todaysSummary');
            const endBtn = document.getElementById('endWorkoutBtn');
            
            if (todaysWorkouts.length === 0) {
                summary.innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 20px;">No exercises logged yet</div>';
                endBtn.classList.add('hidden');
                return;
            }
            
            // Show end workout button
            endBtn.classList.remove('hidden');
            
            summary.innerHTML = todaysWorkouts.map((workout, index) => {
                // Check if cardio workout
                if (workout.cardio) {
                    let badges = '';
                    if (workout.zone2) badges += ' <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Z2</span>';
                    if (workout.norwegian) badges += ' <span style="background: #ff5722; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">üî•</span>';
                    
                    return `
                        <div class="workout-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${workout.exercise}${badges}</strong>
                                <span>${workout.displayText}</span>
                            </div>
                            <button onclick="confirmDeleteExercise(${index})" class="delete-btn">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                }
                
                // Weight training workout
                const displaySets = workout.displaySets || workout.sets;
                const setCount = workout.sets.length;
                
                // If all bodyweight, show "4 sets"
                if (displaySets.length === 1 && displaySets[0] === 'bodyweight') {
                    return `
                        <div class="workout-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${workout.exercise}</strong>
                                <span>${setCount} sets</span>
                            </div>
                            <button onclick="confirmDeleteExercise(${index})" class="delete-btn">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                }
                
                // Otherwise show weights
                return `
                    <div class="workout-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${workout.exercise}</strong>
                            <span>${setCount} sets @ ${displaySets.join('/')} lbs</span>
                        </div>
                        <button onclick="confirmDeleteExercise(${index})" class="delete-btn">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
            
            // Count total sets and volume (only for weight training, skip cardio and bodyweight)
            let totalSets = 0;
            let totalVolume = 0;
            
            todaysWorkouts.forEach(workout => {
                // Skip cardio workouts
                if (workout.cardio) return;
                
                // Count sets
                if (workout.sets) {
                    totalSets += workout.sets.length;
                    
                    // Calculate volume (skip bodyweight)
                    workout.sets.forEach(weight => {
                        if (weight !== 'BW' && !isNaN(weight)) {
                            totalVolume += parseFloat(weight) * 8; // 8 reps per set
                        }
                    });
                }
            });
            
            // Build summary text - only show if there are strength exercises
            if (totalSets > 0) {
                let summaryText = `Total: ${todaysWorkouts.filter(w => !w.cardio).length} exercises, ${totalSets} sets`;
                
                if (totalVolume > 0) {
                    summaryText += `, ${totalVolume.toLocaleString()} lbs`;
                }
                
                summary.innerHTML += `
                    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color); font-weight: bold; color: var(--button-primary);">
                        ${summaryText}
                    </div>
                `;
            }
        }

        // Delete Exercise Functions
        function confirmDeleteExercise(index) {
            const workout = todaysWorkouts[index];
            
            // Build confirmation message
            let message = `Delete this exercise?\n\n${workout.exercise}\n`;
            
            if (workout.cardio) {
                message += workout.displayText;
            } else if (workout.sets) {
                const setCount = workout.sets.length;
                const displaySets = workout.displaySets || workout.sets;
                
                if (displaySets.length === 1 && displaySets[0] === 'bodyweight') {
                    message += `${setCount} sets (bodyweight)`;
                } else {
                    message += `${setCount} sets @ ${displaySets.join('/')} lbs`;
                }
            }
            
            message += '\n\nThis will be permanently removed.';
            
            // Show confirmation dialog
            if (confirm(message)) {
                deleteExercise(index);
            }
        }

        function deleteExercise(index) {
            const workout = todaysWorkouts[index];
            
            // TODO: When Google Sheets is connected, delete rows from spreadsheet here
            // For now, we'll add a placeholder comment
            
            // FUTURE: Delete from Google Sheets
            // await deleteFromGoogleSheets(workout, currentDate);
            
            // Remove from today's workouts array
            todaysWorkouts.splice(index, 1);
            
            // Update the display
            updateTodaysSummary();
            
            // Show success message
            showMessage(`‚úì ${workout.exercise} deleted`, 'success');
            
            // Timer continues running - user may want to re-log corrected exercise
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.className = type;
            msg.textContent = text;
            msg.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    msg.classList.add('hidden');
                }, 3000);
            }
        }

        function filterExercises() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            if (search.length < 2) return;
            
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = '';
            grid.classList.remove('hidden');
            
            Object.keys(EXERCISES).forEach(category => {
                EXERCISES[category].forEach(exercise => {
                    if (exercise.toLowerCase().includes(search)) {
                        const btn = document.createElement('button');
                        btn.className = 'exercise-btn';
                        btn.textContent = exercise;
                        btn.onclick = () => selectExercise(exercise, category);
                        grid.appendChild(btn);
                    }
                });
            });
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Worker registration failed');
            });
        }

        // Timer functions
        function startTimer() {
            workoutStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timerDisplay').textContent = 
                `‚è±Ô∏è Gym time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function clearAllSets() {
            const inputs = document.querySelectorAll('#setInputs input');
            inputs.forEach(input => input.value = '');
            if (inputs.length > 0) {
                inputs[0].focus();
            }
        }

        function endWorkoutSession() {
            if (todaysWorkouts.length === 0) {
                return;
            }

            if (confirm('End your workout session? This will clear today\'s view (data is already saved).')) {
                // Clear today's workouts
                todaysWorkouts = [];
                updateTodaysSummary();
                
                // Hide end workout button
                document.getElementById('endWorkoutBtn').classList.add('hidden');
                
                // Reset timer
                stopTimer();
                startTimer();
                
                // Reset date to today (in case user was entering past workouts)
                currentDate = new Date();
                document.getElementById('currentDate').textContent = formatDate(currentDate);
                
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Clear input section
                document.getElementById('inputSection').classList.add('hidden');
                document.getElementById('previousData').classList.add('hidden');
                document.getElementById('exerciseGrid').classList.add('hidden');
                
                // Clear category selection
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Clear exercise selection
                document.querySelectorAll('.exercise-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                selectedExercise = null;
                selectedCategory = null;
                
                showMessage('‚úì Workout session ended! Ready for next workout.', 'success');
            }
        }

        // Check for midnight and auto-reset
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                if (todaysWorkouts.length > 0) {
                    todaysWorkouts = [];
                    updateTodaysSummary();
                    document.getElementById('endWorkoutBtn').classList.add('hidden');
                    stopTimer();
                    startTimer();
                    showMessage('üåÖ New day! Workout log reset.', 'success');
                }
            }
        }, 1000);
        
        // Periodic session check - show friendly refresh prompt at 50 min
        let hasPromptedRefresh = false;
        setInterval(() => {
            if (shouldPromptRefresh() && !hasPromptedRefresh) {
                hasPromptedRefresh = true;
                const timeRemaining = Math.floor((parseInt(tokenExpiry) - Date.now()) / 60000);
                console.log(`‚è∞ Session expires in ${timeRemaining} minutes - showing refresh prompt`);
                
                // Show friendly non-blocking message
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 90%;
                    text-align: center;
                    cursor: pointer;
                    transition: transform 0.2s;
                `;
                messageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">‚è∞ Session Refresh</div>
                    <div style="font-size: 13px; opacity: 0.9;">Tap here to refresh your session (~${timeRemaining} min remaining)</div>
                `;
                messageDiv.onmouseover = () => messageDiv.style.transform = 'translateX(-50%) scale(1.05)';
                messageDiv.onmouseout = () => messageDiv.style.transform = 'translateX(-50%) scale(1)';
                messageDiv.onclick = () => {
                    messageDiv.remove();
                    signInWithGoogle();
                };
                
                document.body.appendChild(messageDiv);
                
                // Auto-remove after 30 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.style.opacity = '0';
                        setTimeout(() => messageDiv.remove(), 300);
                    }
                }, 30000);
            }
            
            // Reset the prompt flag when token is refreshed
            if (isTokenValid()) {
                hasPromptedRefresh = false;
            }
        }, 30000); // Check every 30 seconds

        // ============================================================================
        // OAUTH2 AUTHENTICATION FUNCTIONS
        // ============================================================================

        function isTokenValid() {
            if (!accessToken || !tokenExpiry) return false;
            const now = Date.now();
            const expiry = parseInt(tokenExpiry);
            // Token is valid if it expires more than 2 minutes from now (58 min of use)
            return expiry > (now + 2 * 60 * 1000);
        }
        
        function shouldPromptRefresh() {
            // Prompt to refresh when 10 minutes remain (50 min into session)
            if (!accessToken || !tokenExpiry) return false;
            const now = Date.now();
            const expiry = parseInt(tokenExpiry);
            const timeRemaining = expiry - now;
            const tenMinutes = 10 * 60 * 1000;
            const twoMinutes = 2 * 60 * 1000;
            // Prompt if between 10 and 2 minutes remaining
            return timeRemaining <= tenMinutes && timeRemaining > twoMinutes;
        }
        
        function saveWorkoutState() {
            // Save current workout session to survive re-authentication
            const state = {
                selectedExercise,
                selectedCategory,
                todaysWorkouts,
                workoutStartTime,
                currentDate: currentDate.toISOString(),
                timerRunning: timerInterval !== null
            };
            localStorage.setItem('workout_session_state', JSON.stringify(state));
            console.log('üíæ Workout state saved before re-auth');
        }
        
        function restoreWorkoutState() {
            const savedState = localStorage.getItem('workout_session_state');
            if (!savedState) return false;
            
            try {
                const state = JSON.parse(savedState);
                console.log('üîÑ Restoring workout state...', state);
                
                // Restore session variables
                selectedExercise = state.selectedExercise;
                selectedCategory = state.selectedCategory;
                todaysWorkouts = state.todaysWorkouts || [];
                workoutStartTime = state.workoutStartTime;
                currentDate = new Date(state.currentDate);
                
                // Restore UI
                updateTodaysSummary();
                if (todaysWorkouts.length > 0) {
                    document.getElementById('endWorkoutBtn').classList.remove('hidden');
                }
                
                // Restart timer if it was running
                if (state.timerRunning && !timerInterval) {
                    startTimer();
                }
                
                // Clear the saved state
                localStorage.removeItem('workout_session_state');
                console.log('‚úÖ Workout state restored');
                return true;
            } catch (error) {
                console.error('‚ùå Error restoring workout state:', error);
                localStorage.removeItem('workout_session_state');
                return false;
            }
        }

        function signInWithGoogle(useSilentAuth = true) {
            // Save workout state before redirecting to OAuth
            saveWorkoutState();
            
            // Build OAuth2 authorization URL
            const authParams = {
                client_id: OAUTH_CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: OAUTH_SCOPES,
                include_granted_scopes: 'true',
                state: 'workout_tracker_auth'
            };
            
            // Only add prompt=none for re-auth attempts (not initial sign-in or after errors)
            // Mobile handles this better than desktop Safari
            if (useSilentAuth && accessToken) {
                authParams.prompt = 'none';
                console.log('üîê Attempting silent re-authentication...');
            } else {
                console.log('üîê Redirecting to Google OAuth (with user interaction)...');
            }
            
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams(authParams);
            
            console.log('üíæ Workout state saved - will restore after auth');
            window.location.href = authUrl;
        }

        function handleOAuthCallback() {
            // Check if we're returning from OAuth
            const hash = window.location.hash;
            
            console.log('üîç Checking for OAuth callback...');
            console.log('üìç Current URL:', window.location.href);
            console.log('üîó Hash:', hash);
            
            // Check for OAuth errors first
            if (hash && hash.includes('error=')) {
                const params = new URLSearchParams(hash.substring(1));
                const error = params.get('error');
                const errorDesc = params.get('error_description');
                
                console.log('‚ùå OAuth Error:', error);
                console.log('üìù Description:', errorDesc);
                
                // Handle interaction_required error (happens on desktop with prompt=none)
                if (error === 'interaction_required' || error === 'consent_required' || error === 'login_required') {
                    console.log('‚ö†Ô∏è Silent auth failed, retrying with user interaction...');
                    
                    // Clean up URL
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    // Retry without prompt=none
                    signInWithGoogle(false); // Pass false to disable silent auth
                    return true;
                }
                
                // For other errors, show overlay and let user try again
                console.log('‚ö†Ô∏è Authentication error - user will need to sign in again');
                window.history.replaceState(null, '', window.location.pathname);
                showAuthOverlay();
                return false;
            }
            
            if (hash && hash.includes('access_token')) {
                console.log('üîê Processing OAuth callback...');
                
                // Parse the hash fragment
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                const expiresIn = params.get('expires_in');
                const state = params.get('state');
                
                console.log('üé´ Token present:', token ? 'Yes' : 'No');
                console.log('‚è±Ô∏è Expires in:', expiresIn);
                console.log('üè∑Ô∏è State:', state);
                
                if (token && state === 'workout_tracker_auth') {
                    // Store token
                    accessToken = token;
                    const expiry = Date.now() + (parseInt(expiresIn) * 1000);
                    tokenExpiry = expiry.toString(); // Also set the global variable!
                    localStorage.setItem('google_access_token', token);
                    localStorage.setItem('google_token_expiry', expiry.toString());
                    
                    console.log('‚úÖ OAuth token stored successfully');
                    console.log('üíæ Token:', token.substring(0, 20) + '...');
                    console.log('‚è∞ Expiry:', new Date(expiry).toLocaleString());
                    
                    // Clean up URL
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    // Hide auth overlay using the proper function
                    hideAuthOverlay();
                    
                    // Restore workout state if we were in the middle of a session
                    restoreWorkoutState();
                    
                    showMessage('‚úì Successfully signed in!', 'success');
                    
                    return true;
                } else {
                    console.log('‚ùå Token validation failed');
                    if (!token) console.log('  - No token found');
                    if (state !== 'workout_tracker_auth') console.log('  - State mismatch:', state);
                }
            } else {
                console.log('‚ÑπÔ∏è No OAuth callback detected');
            }
            return false;
        }

        function signOut() {
            accessToken = null;
            tokenExpiry = null;
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            console.log('üîì Signed out');
            showAuthOverlay();
        }

        function showAuthOverlay() {
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.style.display = 'none'; // Force hide with inline style
                console.log('‚úÖ Auth overlay forcefully hidden');
            } else {
                console.error('‚ùå Could not find authOverlay element');
            }
        }

        // Check authentication on page load
        setTimeout(() => {
            console.log('üîç Starting authentication check...');
            
            // First check if we're returning from OAuth
            if (handleOAuthCallback()) {
                console.log('‚úÖ OAuth callback handled successfully');
                // Successfully authenticated via OAuth callback
                return;
            }
            
            // Reload token from localStorage
            accessToken = localStorage.getItem('google_access_token');
            tokenExpiry = localStorage.getItem('google_token_expiry');
            
            console.log('üíæ Checking stored credentials...');
            console.log('  - Access token present:', accessToken ? 'Yes' : 'No');
            console.log('  - Token expiry:', tokenExpiry ? new Date(parseInt(tokenExpiry)).toLocaleString() : 'None');
            
            // Check if we have a valid token
            if (!isTokenValid()) {
                console.log('‚ö†Ô∏è No valid authentication token');
                showAuthOverlay();
            } else {
                console.log('‚úÖ Valid authentication token found - hiding overlay');
                hideAuthOverlay();
            }
        }, 100);

    </script>
    
    <!-- App Footer -->
    <footer class="app-footer">
        <!-- View Spreadsheet Button -->
        <button class="view-sheet-btn" onclick="window.open('https://docs.google.com/spreadsheets/d/1RPljHN0A5gYn_Mw-2c0IJH9qEB8jvcVla0NaJ1fo5HM/edit', '_blank')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            View Spreadsheet
        </button>
        
        <!-- Connection Status Badge -->
        <div class="connection-status" id="connectionStatus">
            <div class="status-indicator status-connected" id="statusIndicator"></div>
            <span id="statusText">Connected</span>
        </div>
    </footer>
</body>
</html>
